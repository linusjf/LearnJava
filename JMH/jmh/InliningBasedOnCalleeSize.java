package jmh;

import org.openjdk.jmh.annotations.Benchmark;
import org.openjdk.jmh.annotations.Scope;
import org.openjdk.jmh.annotations.State;

/**
 * This test shows, that too large methods will not be inlined, even if they are on a hot path.
 *
 * <p>The doSomeCalculation method in its current form will be inlined in this test. However, if you
 * move the 'assert false' statements directly to the if part of the branch, it will be too large
 * for inlining.
 *
 * <p>The size limit takes assertion statements into account, even if they are disabled. (Which is
 * the case by default.)
 *
 * <p>Run this test with: mvn clean install; java -jar target/benchmarks.jar
 * "jmh.InliningBasedOnCalleeSize.*"
 *
 * <p>To enable diagnostic log about inlining: mvn clean install; java -jar -XX:+PrintCompilation
 * -XX:+UnlockDiagnosticVMOptions -XX:+PrintInlining target/benchmarks.jar
 * "jmh.InliningBasedOnCalleeSize.*"
 *
 * @author David Csakvari
 */
@SuppressWarnings("PMD")
public class InliningBasedOnCalleeSize {

  @Benchmark
  public void testMethod(MyState s) {
    s.valueSink = s.valueSink + doSomeCalculation(1, 1);
    handleUserInteraction(s.valueSink);
  }

  int handleUserInteraction(int startValue) {
    int value = 5;

    for (int step = startValue; step < 50_000; step++)
      value = doSomeCalculation(value, step);

    return value;
  }

  int doSomeCalculation(int startValue, int step) {
    if (step == 0)
      return handleEdgeCase();
    else
      return startValue + step;
  }

  @SuppressWarnings("CPD-START")
  private int handleEdgeCase() {
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    assert false;
    return 1;
  }
  @SuppressWarnings("CPD-END")

  @State(Scope.Thread)
  public static class MyState {
    // just store the result somewhere, to avoid dead code removal
    int valueSink;
  }
}
